#!/bin/bash
# Fetches Vault PostgreSQL password from GCP Secret Manager using VM service account.
# Writes the PostgreSQL storage config to Vault's config directory.
# Runs as ExecStartPre in vault.service.

set -euo pipefail

CONFIG_DIR="{{ config_dir }}"
ENV_FILE="${CONFIG_DIR}/postgres.env"

# Load postgres config
if [ ! -f "${ENV_FILE}" ]; then
  echo "ERROR: ${ENV_FILE} not found" >&2
  exit 1
fi
# shellcheck source=/dev/null
. "${ENV_FILE}"

METADATA_URL="http://metadata.google.internal/computeMetadata/v1"
SECRET_URL="https://secretmanager.googleapis.com/v1"
CONFIG_FILE="${CONFIG_DIR}/storage-postgres.hcl"

# Get access token from VM service account via metadata server
ACCESS_TOKEN=$(curl -sf \
  -H "Metadata-Flavor: Google" \
  "${METADATA_URL}/instance/service-accounts/default/token" \
  | grep -o '"access_token":"[^"]*' | cut -d'"' -f4)

if [ -z "${ACCESS_TOKEN}" ]; then
  echo "ERROR: Failed to get access token from metadata server" >&2
  exit 1
fi

# Fetch secret from Secret Manager
SECRET_NAME="projects/${GCP_PROJECT_ID}/secrets/${POSTGRES_SECRET_NAME}/versions/latest"
DB_PASSWORD=$(curl -sf \
  -H "Authorization: Bearer ${ACCESS_TOKEN}" \
  "${SECRET_URL}/${SECRET_NAME}:access" \
  | grep -o '"data":"[^"]*' | cut -d'"' -f4 | base64 -d)

if [ -z "${DB_PASSWORD}" ]; then
  echo "ERROR: Failed to fetch secret from Secret Manager" >&2
  exit 1
fi

# Write PostgreSQL storage config
HA_BLOCK=""
if [ "${POSTGRES_HA_ENABLED}" = "true" ]; then
  HA_BLOCK="  ha_table       = \"${POSTGRES_HA_TABLE}\""
fi

cat > "${CONFIG_FILE}" <<EOF
storage "postgresql" {
  connection_url = "postgres://${POSTGRES_USER}:${DB_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DATABASE}?sslmode=${POSTGRES_SSLMODE}"
  table          = "${POSTGRES_TABLE}"
  ha_enabled     = "${POSTGRES_HA_ENABLED}"
${HA_BLOCK}
}
EOF

# Secure the config file
chown {{ user }}:{{ group }} "${CONFIG_FILE}"
chmod 0640 "${CONFIG_FILE}"

echo "Vault PostgreSQL storage config written to ${CONFIG_FILE}"
